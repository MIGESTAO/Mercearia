<!DOCTYPE html>
<html lang="pt-MZ">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o de Peixaria Micten - Otimizada</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <style>
        :root {
            --primary-color: #0077b6; --secondary-color: #00b4d8; --accent-color: #f39c12; --danger-color: #e74c3c; --info-color: #3498db; --profit-color: #1abc9c; --purple-color: #9b59b6; --dark-color: #34495e; --outflow-color: #e67e22; --text-color: #34495e; --bg-color: #f4f7f9; --card-bg: #ffffff; --border-color: #e1e4e8; --shadow: 0 8px 25px rgba(0, 0, 0, 0.08); --inner-shadow: 0 2px 5px rgba(0, 0, 0, 0.05); --border-radius: 12px; --transition-speed: 0.3s;
        }
        body { font-family: 'Poppins', sans-serif; background-color: var(--bg-color); margin: 0; padding: 20px; display: flex; justify-content: center; color: var(--text-color); line-height: 1.6; min-height: 100vh; box-sizing: border-box; overflow-x: hidden; }
        .container { background-color: var(--card-bg); padding: 30px; border-radius: var(--border-radius); box-shadow: var(--shadow); width: 100%; max-width: 1600px; display: flex; flex-direction: column; gap: 30px; }
        h1 { display: flex; align-items: center; justify-content: center; gap: 15px; color: var(--primary-color); text-align: center; margin-bottom: 30px; font-weight: 700; letter-spacing: -1px; font-size: 2.2em; background: linear-gradient(45deg, var(--primary-color), var(--secondary-color)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        h1 .logo-icon { font-size: 1.2em; -webkit-text-fill-color: var(--primary-color); }
        h2 { display: flex; justify-content: space-between; align-items: center; color: var(--dark-color); text-align: center; margin-bottom: 25px; font-weight: 600; font-size: 1.7em; border-bottom: 2px solid var(--border-color); padding-bottom: 10px; }
        h3 { color: var(--dark-color); font-weight: 600; margin-top: 20px; margin-bottom: 15px; font-size: 1.2em; }
        .navbar { display: flex; justify-content: center; gap: 10px; margin-bottom: 30px; flex-wrap: wrap; border-bottom: 1px solid var(--border-color); padding-bottom: 20px; }
        .nav-button { padding: 10px 22px; background-color: var(--primary-color); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.95rem; font-weight: 600; transition: all var(--transition-speed) ease; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .nav-button i { margin-right: 8px; }
        .nav-button:hover { transform: translateY(-3px); box-shadow: 0 6px 15px rgba(0,0,0,0.1); }
        .nav-button.active { background-color: var(--secondary-color); transform: translateY(0); }
        .section { padding: 25px; border: 1px solid var(--border-color); border-radius: var(--border-radius); background-color: var(--card-bg); box-shadow: var(--inner-shadow); display: none; animation: fadeIn 0.5s ease-out; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .form-group { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 18px; margin-bottom: 25px; align-items: end; }
        .form-field { display: flex; flex-direction: column; }
        .form-field label { margin-bottom: 8px; font-weight: 600; color: #555; font-size: 0.9em; }
        input, select, textarea { width: 100%; box-sizing: border-box; padding: 12px 15px; border: 1px solid #ced4da; border-radius: 6px; font-size: 1rem; transition: all var(--transition-speed) ease; background-color: #fdfdfd; }
        input:focus, select:focus, textarea:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(0, 119, 182, 0.15); outline: none; }
        textarea { resize: vertical; min-height: 80px; }
        button, .btn { padding: 12px 25px; background-color: var(--primary-color); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: all var(--transition-speed) ease; display: inline-flex; align-items: center; justify-content: center; text-decoration: none; }
        button:disabled { background-color: #cccccc; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-sm { padding: 8px 15px; font-size: 0.9rem; }
        .btn-download { background-color: var(--secondary-color); }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        table th, table td { border-bottom: 1px solid var(--border-color); padding: 12px 15px; text-align: left; vertical-align: middle; font-size: 0.9rem; }
        table th { background-color: #f8f9fa; color: #555; font-weight: 600; text-transform: uppercase; font-size: 0.8rem; }
        table th.sortable { cursor: pointer; }
        table th.sortable:hover { background-color: #e9ecef; }
        table th .sort-icon { margin-left: 8px; color: #aaa; }
        table tbody tr:hover { background-color: #f1f8ff; }
        .stock-low { color: var(--danger-color); font-weight: bold; }
        .delete-btn { background-color: var(--danger-color); } .delete-btn:hover { background-color: #c0392b; }
        .edit-btn { background-color: var(--secondary-color); } .edit-btn:hover { background-color: #0091ad; }
        .adjust-btn { background-color: var(--accent-color); } .adjust-btn:hover { background-color: #d68910; }
        .action-cell { display: flex; gap: 8px; flex-wrap: wrap; }
        .action-cell button { padding: 7px 12px; font-size: 0.8rem; }
        .dashboard-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px; margin-bottom: 20px; }
        .dashboard-filters .btn-group { display: flex; gap: 5px; background-color: #e9ecef; padding: 5px; border-radius: 8px; }
        .dashboard-filters .btn-group button { background-color: transparent; border: none; color: var(--dark-color); font-weight: 600; padding: 8px 15px; border-radius: 6px; cursor: pointer; }
        .dashboard-filters .btn-group button.active { background-color: var(--card-bg); color: var(--primary-color); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { color: white; padding: 25px; border-radius: var(--border-radius); transition: all var(--transition-speed) ease; position: relative; overflow: hidden; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.15); }
        .stat-card .stat-icon { font-size: 2.5em; opacity: 0.8; position: absolute; right: 20px; top: 50%; transform: translateY(-50%); }
        .stat-card h3 { margin: 0 0 10px 0; font-size: 1.1em; font-weight: 600; }
        .stat-card p { font-size: 2.2em; font-weight: 700; margin: 0; line-height: 1; }
        .stat-card.sales { background: linear-gradient(45deg, var(--info-color), #5dade2); }
        .stat-card.profit { background: linear-gradient(45deg, var(--profit-color), #2ecc71); }
        .stat-card.outflow { background: linear-gradient(45deg, var(--outflow-color), #f39c12); }
        .stat-card.products { background: linear-gradient(45deg, var(--primary-color), var(--secondary-color)); }
        .stat-card.low-stock { background: linear-gradient(45deg, var(--danger-color), #f1948a); }
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
        .toast { padding: 15px 20px; border-radius: 8px; font-weight: 600; box-shadow: 0 5px 15px rgba(0,0,0,0.2); opacity: 0; transform: translateX(100%); transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); display: flex; align-items: center; gap: 10px; }
        .toast.show { opacity: 1; transform: translateX(0); }
        .toast.success { background-color: #e8f5e9; color: #2e7d32; border-left: 5px solid var(--secondary-color); }
        .toast.error { background-color: #ffebee; color: #c62828; border-left: 5px solid var(--danger-color); }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.85); display: flex; justify-content: center; align-items: center; z-index: 1000; visibility: hidden; opacity: 0; transition: all 0.3s; }
        .loading-overlay.visible { visibility: visible; opacity: 1; }
        .loading-spinner { border: 8px solid #f3f3f3; border-top: 8px solid var(--primary-color); border-radius: 50%; width: 70px; height: 70px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .search-bar { margin: 20px 0; display: flex; gap: 10px; align-items: center; max-width: 400px; }
        .search-bar i { color: #aaa; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 1002; visibility: hidden; opacity: 0; transition: all 0.3s; }
        .modal.visible { visibility: visible; opacity: 1; }
        .modal-content { background-color: white; padding: 30px; border-radius: var(--border-radius); box-shadow: var(--shadow); max-width: 450px; text-align: center; transform: scale(0.9); opacity: 0; transition: all 0.3s ease-out; }
        .modal.visible .modal-content { transform: scale(1); opacity: 1; }
        .modal-content .button-group { display: flex; justify-content: center; gap: 15px; margin-top: 20px; }
        .auth-section { max-width: 450px; margin: 50px auto; padding: 40px; }
        .auth-form { display: flex; flex-direction: column; gap: 15px; }
        .auth-toggle { margin-top: 20px; font-size: 0.9em; }
        .auth-toggle a { color: var(--primary-color); text-decoration: none; font-weight: 600; }
        .auth-toggle a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div id="toast-container" class="toast-container"></div>
    <div class="loading-overlay" id="loading-overlay"><div class="loading-spinner"></div></div>

    <div class="modal" id="stock-adjustment-modal">
        <div class="modal-content">
            <h3>Ajustar Stock</h3>
            <p>Produto: <strong id="adjustment-product-name"></strong></p>
            <p>Quantidade Atual: <strong id="adjustment-current-stock"></strong></p>
            <form id="stock-adjustment-form">
                <input type="hidden" id="adjustment-product-id">
                <div class="form-field" style="margin-bottom: 15px; text-align: left;"><label for="adjustment-new-quantity">Nova Quantidade Correta</label><input type="number" id="adjustment-new-quantity" min="0" required></div>
                <div class="form-field" style="margin-bottom: 20px; text-align: left;"><label for="adjustment-reason">Motivo do Ajuste</label><textarea id="adjustment-reason" placeholder="Ex: Corre√ß√£o de contagem, produto danificado..." required></textarea></div>
                <div class="button-group"><button type="submit" class="adjust-btn"><i class="fas fa-check"></i> Confirmar Ajuste</button><button type="button" id="cancel-adjustment-btn"><i class="fas fa-times"></i> Cancelar</button></div>
            </form>
        </div>
    </div>
    
    <div class="container">
        <h1><i class="fas fa-fish logo-icon"></i> Gest√£o de Peixaria Micten</h1>

        <nav class="navbar" id="main-navbar" style="display: none;">
            <button class="nav-button" data-section="dashboard-section" onclick="showSection('dashboard-section')"><i class="fas fa-chart-pie"></i> Dashboard</button>
            <button class="nav-button" data-section="product-management-section" onclick="showSection('product-management-section')"><i class="fas fa-boxes-stacked"></i> Produtos</button>
            <button class="nav-button" data-section="stock-management-section" onclick="showSection('stock-management-section')"><i class="fas fa-warehouse"></i> Stock</button>
            <button class="nav-button" data-section="sale-registration-section" onclick="showSection('sale-registration-section')"><i class="fas fa-cash-register"></i> Vender</button>
            <button class="nav-button" data-section="profit-report-section" onclick="showSection('profit-report-section')"><i class="fas fa-percent"></i> Relat√≥rio de Lucros</button>
            <button class="nav-button" data-section="history-section" onclick="showSection('history-section')"><i class="fas fa-history"></i> Hist√≥rico</button>
            <button class="nav-button delete-btn" onclick="logoutUser()"><i class="fas fa-sign-out-alt"></i> Sair</button>
        </nav>

        <main>
            <section id="auth-section" class="section auth-section">
                <div id="login-form-container">
                    <h2><i class="fas fa-sign-in-alt"></i> Login</h2>
                    <div class="auth-form"><input type="email" id="login-email" placeholder="Seu Email" required><input type="password" id="login-password" placeholder="Sua Senha" required><button onclick="loginUser()">Entrar</button></div>
                    <p class="auth-toggle">N√£o tem uma conta? <a href="#" onclick="toggleAuthForm('register')">Registe-se aqui</a></p>
                    <p class="auth-toggle"><a href="#" onclick="toggleAuthForm('forgot-password')">Esqueceu a senha?</a></p>
                </div>
                <div id="register-form-container" style="display: none;">
                    <h2><i class="fas fa-user-plus"></i> Registo</h2>
                    <div class="auth-form"><input type="email" id="register-email" placeholder="Seu Email" required><input type="password" id="register-password" placeholder="Sua Senha (m√≠n. 6 caracteres)" required><input type="password" id="register-confirm-password" placeholder="Confirmar Senha" required><button onclick="registerUser()">Registar</button></div>
                    <p class="auth-toggle">J√° tem uma conta? <a href="#" onclick="toggleAuthForm('login')">Fa√ßa login</a></p>
                </div>
                <div id="forgot-password-form-container" style="display: none;">
                    <h2><i class="fas fa-key"></i> Recuperar Senha</h2>
                    <div class="auth-form"><input type="email" id="forgot-password-email" placeholder="Email da sua conta" required><button onclick="sendPasswordResetEmail()">Enviar Email</button></div>
                    <p class="auth-toggle">Voltar ao <a href="#" onclick="toggleAuthForm('login')">Login</a></p>
                </div>
            </section>

            <section id="dashboard-section" class="section">
                <div class="dashboard-header">
                    <h2><i class="fas fa-chart-pie"></i> Painel de Controlo</h2>
                    <div class="dashboard-filters"><div class="btn-group" id="dashboard-period-filter"><button class="active" data-period="today">Hoje</button><button data-period="week">Esta Semana</button><button data-period="month">Este M√™s</button><button data-period="all">Sempre</button></div></div>
                </div>
                <div class="dashboard-grid">
                    <div class="stat-card sales"><h3>Total de Vendas</h3><p id="dashboard-total-sales">0.00 MZN</p><i class="stat-icon fas fa-dollar-sign"></i></div>
                    <div class="stat-card profit"><h3>Lucro Total Estimado</h3><p id="dashboard-total-profit">0.00 MZN</p><i class="stat-icon fas fa-chart-line"></i></div>
                    <div class="stat-card outflow"><h3>Total de Sa√≠das (Unid.)</h3><p id="dashboard-total-outflow">0</p><i class="stat-icon fas fa-shipping-fast"></i></div>
                    <div class="stat-card products"><h3>Produtos Registados</h3><p id="dashboard-total-products">0</p><i class="stat-icon fas fa-boxes-stacked"></i></div>
                    <div class="stat-card low-stock"><h3>Alertas de Stock Baixo</h3><p id="dashboard-low-stock-count">0</p><i class="stat-icon fas fa-exclamation-triangle"></i></div>
                </div>
            </section>
            
            <section id="product-management-section" class="section">
                <h2><span><i class="fas fa-boxes-stacked"></i> Gest√£o de Produtos</span><button class="btn btn-sm btn-download" onclick="exportProductsToCSV()"><i class="fas fa-download"></i> Download CSV</button></h2>
                <form id="product-form">
                    <h3>Adicionar / Editar Produto</h3>
                    <div class="form-group">
                        <input type="hidden" id="product-id">
                        <div class="form-field"><label for="product-name">Nome do Produto</label><input type="text" id="product-name" placeholder="Ex: Peixe Pescada 1kg" required></div>
                        <div class="form-field"><label for="product-purchase-price">Pre√ßo Compra (MZN)</label><input type="number" id="product-purchase-price" placeholder="500.00" step="0.01" required></div>
                        <div class="form-field"><label for="product-sale-price">Pre√ßo Venda (MZN)</label><input type="number" id="product-sale-price" placeholder="650.00" step="0.01" required></div>
                        <div class="form-field" id="initial-quantity-field"><label for="product-quantity">Quantidade Inicial</label><input type="number" id="product-quantity" placeholder="10" required></div>
                        <div class="form-field"><button type="submit" id="save-product-btn"><i class="fas fa-plus-circle"></i> Adicionar Produto</button></div>
                    </div>
                </form>
                <h3><i class="fas fa-list-ul"></i> Lista de Produtos</h3>
                <div class="search-bar"><i class="fas fa-search"></i><input type="text" id="product-search" onkeyup="filterTable('product-list-body', 0)" placeholder="Pesquisar por nome..."></div>
                <table>
                    <thead><tr><th class="sortable" onclick="sortTable(this, 0)">Nome <span class="sort-icon"><i class="fas fa-sort"></i></span></th><th class="sortable" onclick="sortTable(this, 1, 'number')">Pre√ßo Venda <span class="sort-icon"><i class="fas fa-sort"></i></span></th><th class="sortable" onclick="sortTable(this, 2, 'number')">Stock <span class="sort-icon"><i class="fas fa-sort"></i></span></th><th>A√ß√µes</th></tr></thead>
                    <tbody id="product-list-body"></tbody>
                </table>
            </section>

            <section id="stock-management-section" class="section">
                <h2><i class="fas fa-warehouse"></i> Gest√£o de Stock</h2>
                <form id="stock-entry-form">
                    <h3>Registar Entrada de Stock (Reposi√ß√£o)</h3>
                    <div class="form-group">
                        <div class="form-field"><label for="stock-entry-product-select">Produto</label><select id="stock-entry-product-select" required></select></div>
                        <div class="form-field"><label for="stock-entry-quantity">Quantidade a Adicionar</label><input type="number" id="stock-entry-quantity" placeholder="Ex: 5" min="1" required></div>
                        <div class="form-field"><label for="stock-entry-supplier">Fornecedor</label><input type="text" id="stock-entry-supplier" placeholder="Ex: Fornecedor Local"></div>
                        <div class="form-field"><button type="submit"><i class="fas fa-arrow-alt-circle-down"></i> Registar Entrada</button></div>
                    </div>
                </form>
            </section>

            <section id="sale-registration-section" class="section">
                <h2><i class="fas fa-cash-register"></i> Registar Venda</h2>
                <form id="sale-form">
                    <div class="form-group">
                        <div class="form-field"><label for="sale-product-select">Produto</label><select id="sale-product-select" required></select></div>
                        <div class="form-field"><label for="sale-quantity">Quantidade a Vender</label><input type="number" id="sale-quantity" placeholder="Ex: 1" min="1" required></div>
                        <div class="form-field"><button type="submit" id="register-sale-btn" disabled><i class="fas fa-shopping-cart"></i> Registar Venda</button></div>
                    </div>
                </form>
            </section>

            <section id="profit-report-section" class="section">
                <h2><span><i class="fas fa-percent"></i> Relat√≥rio de Lucratividade por Produto</span><button class="btn btn-sm btn-download" onclick="exportProfitReportToCSV()"><i class="fas fa-download"></i> Download CSV</button></h2>
                <div class="search-bar"><i class="fas fa-search"></i><input type="text" id="profit-report-search" onkeyup="filterTable('profit-report-table-body', 0)" placeholder="Pesquisar por produto..."></div>
                <table>
                    <thead><tr><th class="sortable" onclick="sortTable(this, 0)">Produto <span class="sort-icon"><i class="fas fa-sort"></i></span></th><th class="sortable" onclick="sortTable(this, 1, 'number')">Unid. Vendidas <span class="sort-icon"><i class="fas fa-sort"></i></span></th><th class="sortable" onclick="sortTable(this, 2, 'number')">Receita Total <span class="sort-icon"><i class="fas fa-sort"></i></span></th><th class="sortable" onclick="sortTable(this, 3, 'number')">Lucro Total <span class="sort-icon"><i class="fas fa-sort"></i></span></th><th class="sortable" onclick="sortTable(this, 4, 'number')">Margem M√©dia <span class="sort-icon"><i class="fas fa-sort"></i></span></th></tr></thead>
                    <tbody id="profit-report-table-body"></tbody>
                </table>
            </section>

            <section id="history-section" class="section">
                 <h2><span><i class="fas fa-history"></i> Hist√≥rico de Movimenta√ß√µes</span><button class="btn btn-sm btn-download" onclick="exportHistoryToCSV()"><i class="fas fa-download"></i> Download CSV</button></h2>
                 <div class="search-bar"><i class="fas fa-search"></i><input type="text" id="history-search" onkeyup="filterTable('movement-history-table-body', 1)" placeholder="Pesquisar por produto..."></div>
                 <table>
                    <thead><tr><th class="sortable" onclick="sortTable(this, 0, 'date')">Data/Hora <span class="sort-icon"><i class="fas fa-sort"></i></span></th><th class="sortable" onclick="sortTable(this, 1)">Produto <span class="sort-icon"><i class="fas fa-sort"></i></span></th><th>Tipo</th><th>Qtde</th><th>Total (MZN)</th><th>Lucro / Margem</th><th>Detalhes</th><th>A√ß√£o</th></tr></thead>
                    <tbody id="movement-history-table-body"></tbody>
                 </table>
            </section>
        </main>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyA1Fefo19PT7dap3J0z4ohE2BVhub7U9N4", authDomain: "mercearia-e1e8e.firebaseapp.com", projectId: "mercearia-e1e8e", storageBucket: "mercearia-e1e8e.appspot.com", messagingSenderId: "211104638560", appId: "1:211104638560:web:0f2cd09b00e5f572bb0505" };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let products = [], movements = [], productsListener = null, movementsListener = null;
        const STOCK_LOW_THRESHOLD = 10;

        function showLoading() { document.getElementById('loading-overlay').classList.add('visible'); }
        function hideLoading() { document.getElementById('loading-overlay').classList.remove('visible'); }
        
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container'); const toast = document.createElement('div'); toast.className = `toast ${type}`;
            const icon = type === 'success' ? 'fa-check-circle' : 'fa-times-circle'; toast.innerHTML = `<i class="fas ${icon}"></i> ${message}`;
            container.appendChild(toast); setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 500); }, 4000);
        }

        function toggleAuthForm(formType) {
            document.getElementById('login-form-container').style.display = formType === 'login' ? 'block' : 'none';
            document.getElementById('register-form-container').style.display = formType === 'register' ? 'block' : 'none';
            document.getElementById('forgot-password-form-container').style.display = formType === 'forgot-password' ? 'block' : 'none';
        }

        auth.onAuthStateChanged(user => {
            const allSections = document.querySelectorAll('.section');
            if (user) {
                document.getElementById('auth-section').classList.remove('active'); document.getElementById('main-navbar').style.display = 'flex'; showSection('dashboard-section'); listenToData();
            } else {
                if (productsListener) productsListener(); if (movementsListener) movementsListener(); products = []; movements = [];
                document.getElementById('main-navbar').style.display = 'none'; allSections.forEach(s => s.classList.remove('active'));
                document.getElementById('auth-section').classList.add('active'); toggleAuthForm('login'); hideLoading();
            }
        });
        
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            document.querySelectorAll('.nav-button').forEach(btn => btn.classList.toggle('active', btn.dataset.section === sectionId));
        }
        
        function handleError(error, context = "Opera√ß√£o") { console.error(`${context} falhou:`, error); showToast(`Erro em ${context}: ${error.message}`, 'error'); hideLoading(); }

        function listenToData() {
            showLoading();
            if (productsListener) productsListener();
            productsListener = db.collection('products').orderBy('name').onSnapshot(snapshot => { products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); renderAllUI(); }, e => handleError(e, "Leitura de Produtos"));
            if (movementsListener) movementsListener();
            movementsListener = db.collection('movements').orderBy('timestamp', 'desc').onSnapshot(snapshot => { movements = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); renderAllUI(); }, e => handleError(e, "Leitura do Hist√≥rico"));
        }
        
        function renderAllUI() { renderProducts(); updateProductSelects(); renderMovementHistory(); renderProfitReport(); const activeFilter = document.querySelector('#dashboard-period-filter button.active')?.dataset.period || 'today'; calculateDashboardStats(activeFilter); hideLoading(); }
        
        function calculateDashboardStats(period = 'today') {
            let totalSales = 0, totalProfit = 0, totalOutflow = 0, lowStockCount = 0;
            const now = new Date(); let startDate = new Date(0);
            if (period === 'today') { startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate()); }
            if (period === 'week') { const dayOfWeek = now.getDay() === 0 ? 6 : now.getDay() - 1; startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - dayOfWeek); }
            if (period === 'month') { startDate = new Date(now.getFullYear(), now.getMonth(), 1); }
            
            const filteredMovements = movements.filter(m => m.timestamp && m.timestamp.toDate() >= startDate);
            filteredMovements.forEach(mov => { 
                if (mov.type === 'saida (venda)') { totalSales += mov.totalSale || 0; totalProfit += mov.totalProfit || 0; }
                if (mov.type.includes('saida') || (mov.type === 'ajuste' && mov.quantity < 0)) { totalOutflow += Math.abs(mov.quantity); }
            });
            
            products.forEach(p => { if (p.quantity > 0 && p.quantity <= STOCK_LOW_THRESHOLD) lowStockCount++; });

            document.getElementById('dashboard-total-sales').textContent = `${totalSales.toFixed(2)} MZN`;
            document.getElementById('dashboard-total-profit').textContent = `${totalProfit.toFixed(2)} MZN`;
            document.getElementById('dashboard-total-outflow').textContent = totalOutflow;
            document.getElementById('dashboard-total-products').textContent = products.length;
            document.getElementById('dashboard-low-stock-count').textContent = lowStockCount;
        }

        function renderProducts() {
            const tableBody = document.getElementById('product-list-body'); tableBody.innerHTML = '';
            products.forEach(p => {
                const row = tableBody.insertRow(); row.id = `product-row-${p.id}`;
                row.innerHTML = `<td>${p.name}</td><td>${p.salePrice.toFixed(2)}</td><td>${p.quantity}</td>
                    <td class="action-cell">
                        <button class="edit-btn btn-sm" onclick="editProduct('${p.id}')" title="Editar Produto"><i class="fas fa-edit"></i></button>
                        <button class="adjust-btn btn-sm" onclick="openAdjustmentModal('${p.id}')" title="Ajustar Stock"><i class="fas fa-exchange-alt"></i></button>
                        <button class="delete-btn btn-sm" onclick="deleteProduct('${p.id}')" title="Apagar Produto"><i class="fas fa-trash"></i></button>
                    </td>`;
            });
        }
        
        function updateProductSelects() {
            const saleSelect = document.getElementById('sale-product-select'), stockSelect = document.getElementById('stock-entry-product-select');
            saleSelect.innerHTML = '<option value="">Selecione um produto</option>'; stockSelect.innerHTML = '<option value="">Selecione um produto</option>';
            products.forEach(p => {
                const saleOption = new Option(`${p.name} (Stock: ${p.quantity})`, p.id);
                if (p.quantity <= 0) saleOption.disabled = true;
                saleSelect.add(saleOption); stockSelect.add(new Option(p.name, p.id));
            });
        }

        function renderMovementHistory() {
            const tableBody = document.getElementById('movement-history-table-body'); tableBody.innerHTML = '';
            movements.forEach(mov => {
                const row = tableBody.insertRow(); let profitCellHTML = '<td>-</td>';
                if (mov.type === 'saida (venda)') {
                    const profit = mov.totalProfit || 0; const sale = mov.totalSale || 0; const margin = sale > 0 ? (profit / sale) * 100 : 0;
                    const profitColor = profit >= 0 ? 'var(--profit-color)' : 'var(--danger-color)';
                    profitCellHTML = `<td style="color: ${profitColor}; font-weight: bold;">${profit.toFixed(2)} (${margin.toFixed(1)}%)</td>`;
                }
                const total = mov.type.includes('entrada') ? mov.totalCost : mov.totalSale;
                row.innerHTML = `<td data-sort-value="${mov.timestamp ? mov.timestamp.toMillis() : 0}">${mov.timestamp ? new Date(mov.timestamp.toDate()).toLocaleString('pt-MZ') : ''}</td>
                    <td>${mov.productName}</td><td>${mov.type}</td><td>${mov.quantity}</td><td>${(total || 0).toFixed(2)}</td>${profitCellHTML}<td>${mov.details || ''}</td>
                    <td class="action-cell"><button class="delete-btn btn-sm" onclick="deleteMovement('${mov.id}')" title="Apagar este registo"><i class="fas fa-trash"></i></button></td>`;
            });
        }

        function renderProfitReport() {
            const reportData = {};
            movements.forEach(mov => {
                if(mov.type !== 'saida (venda)') return;
                if(!reportData[mov.productId]) { reportData[mov.productId] = { name: mov.productName, units: 0, revenue: 0, profit: 0 }; }
                reportData[mov.productId].units += mov.quantity; reportData[mov.productId].revenue += mov.totalSale; reportData[mov.productId].profit += mov.totalProfit;
            });
            const reportArray = Object.values(reportData).sort((a,b) => b.profit - a.profit);
            const tableBody = document.getElementById('profit-report-table-body'); tableBody.innerHTML = '';
            reportArray.forEach(item => {
                const margin = item.revenue > 0 ? (item.profit / item.revenue) * 100 : 0;
                const row = tableBody.insertRow();
                row.innerHTML = `<td>${item.name}</td><td>${item.units}</td><td>${item.revenue.toFixed(2)}</td><td style="color:var(--profit-color);font-weight:bold;">${item.profit.toFixed(2)}</td><td>${margin.toFixed(1)}%</td>`;
            });
        }

        async function loginUser() { try { await auth.signInWithEmailAndPassword(document.getElementById('login-email').value, document.getElementById('login-password').value); } catch(e) { handleError(e, 'Login'); } }
        async function registerUser() { const pass = document.getElementById('register-password').value; if (pass !== document.getElementById('register-confirm-password').value) { showToast('As senhas n√£o coincidem.', 'error'); return; } try { await auth.createUserWithEmailAndPassword(document.getElementById('register-email').value, pass); } catch (e) { handleError(e, 'Registo'); } }
        async function logoutUser() { await auth.signOut(); showToast('Sess√£o encerrada.', 'success'); }
        async function sendPasswordResetEmail() { try { await auth.sendPasswordResetEmail(document.getElementById('forgot-password-email').value); showToast('Email de recupera√ß√£o enviado!', 'success'); } catch(e) { handleError(e, 'Recupera√ß√£o de Senha'); } }

        document.getElementById('product-form').addEventListener('submit', e => { e.preventDefault(); saveProduct(); });
        async function saveProduct() {
            const id = document.getElementById('product-id').value; const isEditing = !!id;
            const name = document.getElementById('product-name').value.trim();
            const purchasePrice = parseFloat(document.getElementById('product-purchase-price').value);
            const salePrice = parseFloat(document.getElementById('product-sale-price').value);
            if (!name) { showToast('O nome do produto √© obrigat√≥rio.', 'error'); return; }
            if (isNaN(purchasePrice) || isNaN(salePrice) || purchasePrice <= 0 || salePrice <= 0) { showToast('Os pre√ßos devem ser n√∫meros maiores que zero.', 'error'); return; }

            const productData = { name, purchasePrice, salePrice };
            showLoading();
            try {
                if (isEditing) { await db.collection('products').doc(id).update(productData); showToast('Produto atualizado!', 'success'); } 
                else { const quantity = parseInt(document.getElementById('product-quantity').value) || 0; const newProdRef = await db.collection('products').add({ ...productData, quantity }); if (quantity > 0) { const initialMovement = { productId: newProdRef.id, productName: name, type: 'entrada (inicial)', quantity, totalCost: productData.purchasePrice * quantity, details: 'Stock inicial do registo', timestamp: firebase.firestore.FieldValue.serverTimestamp() }; await db.collection('movements').add(initialMovement); } showToast('Produto adicionado com sucesso!', 'success'); }
                clearProductForm();
            } catch (e) { handleError(e, "Salvar Produto"); }
        }
        
        function clearProductForm() { document.getElementById('product-form').reset(); document.getElementById('product-id').value = ''; document.getElementById('initial-quantity-field').style.display = 'flex'; document.getElementById('product-quantity').required = true; document.getElementById('save-product-btn').innerHTML = '<i class="fas fa-plus-circle"></i> Adicionar Produto'; }
        function editProduct(id) { const p = products.find(prod => prod.id === id); if (!p) return; document.getElementById('product-id').value = p.id; document.getElementById('product-name').value = p.name; document.getElementById('product-purchase-price').value = p.purchasePrice; document.getElementById('product-sale-price').value = p.salePrice; document.getElementById('initial-quantity-field').style.display = 'none'; document.getElementById('product-quantity').required = false; document.getElementById('save-product-btn').innerHTML = '<i class="fas fa-save"></i> Salvar Altera√ß√µes'; showSection('product-management-section'); window.scrollTo(0,0); }
        async function deleteProduct(id) { if (!confirm("Tem a certeza que quer apagar este produto? O seu hist√≥rico ser√° mantido, mas o produto ser√° removido da lista.")) return; showLoading(); try { await db.collection('products').doc(id).delete(); showToast('Produto apagado.', 'success'); } catch (e) { handleError(e, "Apagar Produto"); } }

        async function deleteMovement(movementId) {
            const movement = movements.find(m => m.id === movementId);
            if (!movement) { showToast('Registo n√£o encontrado.', 'error'); return; }
            if (!confirm(`Tem a CERTEZA que quer apagar este registo do hist√≥rico?\n\nTipo: ${movement.type}\nProduto: ${movement.productName}\nQuantidade: ${movement.quantity}\n\nO stock do produto ser√° corrigido automaticamente.`)) return;

            showLoading();
            let quantityToRevert = 0;
            if (movement.type.includes('saida') || (movement.type === 'ajuste' && movement.quantity < 0)) { quantityToRevert = movement.quantity; } 
            else { quantityToRevert = -movement.quantity; }
            
            const productRef = db.collection('products').doc(movement.productId);
            const movementRef = db.collection('movements').doc(movementId);

            try {
                await db.runTransaction(async (transaction) => {
                    const productDoc = await transaction.get(productRef);
                    if (productDoc.exists) {
                        transaction.update(productRef, { quantity: firebase.firestore.FieldValue.increment(quantityToRevert) });
                    }
                    transaction.delete(movementRef);
                });
                showToast('Registo do hist√≥rico apagado e stock corrigido.', 'success');
            } catch (e) { handleError(e, "Apagar Registo de Hist√≥rico"); } finally { hideLoading(); }
        }

        document.getElementById('sale-form').addEventListener('submit', e => { e.preventDefault(); registerSale(); });
        async function registerSale() {
            const productId = document.getElementById('sale-product-select').value, quantity = parseInt(document.getElementById('sale-quantity').value);
            if (!productId || !quantity || quantity <= 0) { showToast('Selecione um produto e quantidade.', 'error'); return; }
            const product = products.find(p => p.id === productId);
            if (!product.salePrice || product.salePrice <= 0) { showToast(`O produto "${product.name}" n√£o tem um pre√ßo de venda v√°lido.`, 'error'); return; }
            if (product.quantity < quantity) { showToast(`Stock insuficiente. Apenas ${product.quantity}.`, 'error'); return; }
            showLoading();
            const productRef = db.collection('products').doc(productId);
            const saleData = { productId, productName: product.name, type: 'saida (venda)', quantity, salePrice: product.salePrice, purchasePrice: product.purchasePrice, totalSale: product.salePrice * quantity, totalProfit: (product.salePrice - product.purchasePrice) * quantity, timestamp: firebase.firestore.FieldValue.serverTimestamp(), details: 'Venda registada' };
            try { await productRef.update({ quantity: firebase.firestore.FieldValue.increment(-quantity) }); await db.collection('movements').add(saleData); showToast('Venda registada!', 'success'); document.getElementById('sale-form').reset(); } catch (e) { handleError(e, "Registar Venda"); }
        }
        document.getElementById('sale-product-select').addEventListener('change', function() { document.getElementById('register-sale-btn').disabled = !this.value; });
        
        document.getElementById('stock-entry-form').addEventListener('submit', async e => { e.preventDefault(); const productId = document.getElementById('stock-entry-product-select').value, quantity = parseInt(document.getElementById('stock-entry-quantity').value); if (!productId || !quantity || quantity <= 0) return; const product = products.find(p => p.id === productId); const movement = { productId, productName: product.name, type: 'entrada (reposi√ß√£o)', quantity, totalCost: product.purchasePrice * quantity, details: document.getElementById('stock-entry-supplier').value, timestamp: firebase.firestore.FieldValue.serverTimestamp() }; showLoading(); try { await db.collection('products').doc(productId).update({ quantity: firebase.firestore.FieldValue.increment(quantity) }); await db.collection('movements').add(movement); showToast('Entrada de stock registada!', 'success'); document.getElementById('stock-entry-form').reset(); } catch(err) { handleError(err, 'Entrada de Stock'); } });

        function openAdjustmentModal(productId) { const p = products.find(prod => prod.id === productId); if(!p) return; document.getElementById('adjustment-product-id').value = productId; document.getElementById('adjustment-product-name').textContent = p.name; document.getElementById('adjustment-current-stock').textContent = p.quantity; document.getElementById('adjustment-new-quantity').value = p.quantity; document.getElementById('stock-adjustment-modal').classList.add('visible'); }
        document.getElementById('cancel-adjustment-btn').addEventListener('click', () => document.getElementById('stock-adjustment-modal').classList.remove('visible'));
        document.getElementById('stock-adjustment-form').addEventListener('submit', async e => { e.preventDefault(); const productId = document.getElementById('adjustment-product-id').value; const newQuantity = parseInt(document.getElementById('adjustment-new-quantity').value); const reason = document.getElementById('adjustment-reason').value.trim(); if (reason === '') { showToast('O motivo do ajuste √© obrigat√≥rio.', 'error'); return; } const product = products.find(p => p.id === productId); const adjustment = newQuantity - product.quantity; if(adjustment === 0) { showToast('Nenhuma altera√ß√£o na quantidade.', 'error'); return; } const movement = { productId, productName: product.name, type: `ajuste`, quantity: adjustment, details: reason, timestamp: firebase.firestore.FieldValue.serverTimestamp() }; showLoading(); try { await db.collection('products').doc(productId).update({ quantity: newQuantity }); await db.collection('movements').add(movement); showToast('Stock ajustado com sucesso!', 'success'); document.getElementById('stock-adjustment-modal').classList.remove('visible'); } catch(err) { handleError(err, 'Ajuste de Stock'); } });

        document.getElementById('dashboard-period-filter').addEventListener('click', e => { if (e.target.tagName === 'BUTTON') { document.querySelector('#dashboard-period-filter button.active').classList.remove('active'); e.target.classList.add('active'); calculateDashboardStats(e.target.dataset.period); } });

        function sortTable(th, colIndex, type = 'string') { const table = th.closest('table'); const tbody = table.querySelector('tbody'); const dir = th.dataset.dir = -(th.dataset.dir || -1); const icon = th.querySelector('.sort-icon i'); Array.from(tbody.rows).sort((a, b) => { let aVal = a.cells[colIndex].dataset.sortValue || a.cells[colIndex].textContent.trim(); let bVal = b.cells[colIndex].dataset.sortValue || b.cells[colIndex].textContent.trim(); if (type === 'number') { aVal = parseFloat(aVal.replace(/[^0-9.-]+/g,"")) || 0; bVal = parseFloat(bVal.replace(/[^0-9.-]+/g,"")) || 0; } return (aVal > bVal ? 1 : (aVal < bVal ? -1 : 0)) * dir; }).forEach(r => tbody.appendChild(r)); document.querySelectorAll(`#${table.id} .sort-icon i`).forEach(i => i.className = 'fas fa-sort'); icon.className = `fas fa-sort-${dir > 0 ? 'up' : 'down'}`; }
        function filterTable(tbodyId, colIndex) { const searchTerm = event.target.value.toLowerCase(); document.querySelectorAll(`#${tbodyId} tr`).forEach(row => { const cellText = row.cells[colIndex].textContent.toLowerCase(); row.style.display = cellText.includes(searchTerm) ? '' : 'none'; }); }

        function formatCsvCell(value) {
            let finalValue = value === null || value === undefined ? '' : String(value);
            if (finalValue.includes(',') || finalValue.includes('"') || finalValue.includes('\n')) {
                finalValue = `"${finalValue.replace(/"/g, '""')}"`;
            }
            return finalValue;
        }
        function downloadCSV(data, filename = 'relatorio.csv') {
            if(data.length === 0) { showToast('Nenhum dado para exportar.', 'error'); return; }
            const header = Object.keys(data[0]);
            const csv = [ header.join(','), ...data.map(row => header.map(fieldName => formatCsvCell(row[fieldName])).join(',')) ].join('\r\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob); link.setAttribute("href", url); link.setAttribute("download", filename); link.style.visibility = 'hidden'; document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }
        function exportProductsToCSV() { const data = products.map(p => ({ 'ID': p.id, 'Nome': p.name, 'Preco_Custo_MZN': p.purchasePrice, 'Preco_Venda_MZN': p.salePrice, 'Quantidade_Stock': p.quantity })); downloadCSV(data, 'relatorio_produtos.csv'); }
        function exportHistoryToCSV() { const data = movements.map(m => ({ 'Data': new Date(m.timestamp.toDate()).toLocaleString('pt-MZ'), 'Produto': m.productName, 'Tipo': m.type, 'Quantidade': m.quantity, 'Total_Venda_MZN': m.totalSale || 0, 'Total_Custo_MZN': m.totalCost || 0, 'Lucro_MZN': m.totalProfit || 0, 'Detalhes': m.details })); downloadCSV(data, 'historico_movimentacoes.csv'); }
        function exportProfitReportToCSV() { const reportData = {}; movements.forEach(mov => { if(mov.type !== 'saida (venda)') return; if(!reportData[mov.productId]) { reportData[mov.productId] = { name: mov.productName, units: 0, revenue: 0, profit: 0 }; } reportData[mov.productId].units += mov.quantity; reportData[mov.productId].revenue += mov.totalSale; reportData[mov.productId].profit += mov.totalProfit; }); if(Object.keys(reportData).length === 0) { showToast('Nenhum dado de lucro para exportar.', 'error'); return; } const data = Object.values(reportData).map(item => ({ 'Produto': item.name, 'Unidades_Vendidas': item.units, 'Receita_Total_MZN': item.revenue.toFixed(2), 'Lucro_Total_MZN': item.profit.toFixed(2), 'Margem_Media_Perc': (item.revenue > 0 ? (item.profit/item.revenue)*100 : 0).toFixed(1) })); downloadCSV(data, 'relatorio_lucros.csv'); }

        document.addEventListener('DOMContentLoaded', () => {});
    </script>
</body>
</html>
